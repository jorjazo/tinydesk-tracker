services:
  tinydesk-tracker:
    build: .
    image: tinydesk-tracker:latest
    ports:
      - "5000:5000"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # YouTube API Configuration
      YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
      NPR_MUSIC_CHANNEL_ID: ${NPR_MUSIC_CHANNEL_ID:-UC4eYXhJI4-7wSWc8UNRwD4A}
      TINY_DESK_PLAYLIST_ID: ${TINY_DESK_PLAYLIST_ID:-PL1B627337ED6F55F0}
      
      DATABASE_URL: jdbc:postgresql://postgres:5432/tinydesk
      DATABASE_USERNAME: tinydesk
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
     
      # Scheduler Configuration
      UPDATE_INTERVAL_HOURS: ${UPDATE_INTERVAL_HOURS:-6}
      UPDATE_CRON: ${UPDATE_CRON:-0 */30 * * * *}
      SCHEDULER_ENABLED: ${SCHEDULER_ENABLED:-true}
      
      # API Configuration
      MAX_RESULTS_PER_REQUEST: ${MAX_RESULTS_PER_REQUEST:-50}
      TOTAL_VIDEOS_TO_FETCH: ${TOTAL_VIDEOS_TO_FETCH:-1000}
      UPDATE_LOCK_TTL_SECONDS: ${UPDATE_LOCK_TTL_SECONDS:-7200}
    volumes:
      - ./data:/app/data
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/status"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
  postgres:
   image: postgres:16-alpine
   environment:
     POSTGRES_DB: tinydesk
     POSTGRES_USER: tinydesk
     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
   volumes:
     - postgres-data:/var/lib/postgresql/data
   restart: unless-stopped
   healthcheck:
     test: ["CMD-SHELL", "pg_isready -U tinydesk"]
     interval: 10s
     timeout: 5s
     retries: 5

volumes:
 postgres-data:
