<!DOCTYPE html>
<html>
<head>
    <title>Ranking History - Tiny Desk Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
:root {
    color-scheme: light;
    --gradient-start: #0f172a;
    --gradient-mid: #1e3a8a;
    --gradient-end: #8b5cf6;
    --card-bg: rgba(255, 255, 255, 0.9);
    --card-border: rgba(148, 163, 184, 0.2);
    --card-shadow: 0 30px 60px rgba(15, 23, 42, 0.32);
    --header-gradient: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(236, 72, 153, 0.22));
    --accent: #6366f1;
    --accent-strong: #4338ca;
    --muted: #64748b;
    --muted-strong: #475569;
    --success: #16a34a;
    --danger: #ef4444;
    --neutral: #94a3b8;
    --divider: rgba(148, 163, 184, 0.25);
    --text-primary: #0f172a;
    --text-secondary: #1f2937;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: radial-gradient(120% 160% at 0% 0%, rgba(236, 72, 153, 0.35) 0%, rgba(15, 23, 42, 0.92) 40%), radial-gradient(90% 140% at 110% 10%, rgba(129, 140, 248, 0.4) 0%, rgba(15, 23, 42, 0.95) 44%), linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-mid) 50%, var(--gradient-end) 100%);
    min-height: 100vh;
    padding: 48px 24px;
    color: var(--text-primary);
    position: relative;
    overflow-x: hidden;
    display: flex;
    justify-content: center;
}

body::before,
body::after {
    content: '';
    position: absolute;
    width: 500px;
    height: 500px;
    border-radius: 50%;
    filter: blur(180px);
    opacity: 0.18;
    z-index: 0;
    pointer-events: none;
}

body::before {
    background: #ec4899;
    top: -220px;
    left: -160px;
}

body::after {
    background: #818cf8;
    bottom: -240px;
    right: -180px;
}

.container {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 1420px;
    margin: 0 auto;
    background: var(--card-bg);
    border-radius: 32px;
    border: 1px solid var(--card-border);
    box-shadow: var(--card-shadow);
    overflow: hidden;
    backdrop-filter: blur(12px);
}

.container::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.28), rgba(255, 255, 255, 0.05));
    opacity: 0.32;
    pointer-events: none;
}

.header {
    position: relative;
    background: var(--header-gradient);
    padding: 56px 56px 44px;
    margin-bottom: 24px;
    overflow: hidden;
}

.header::after {
    content: '';
    position: absolute;
    inset: -18% 25% -40% -30%;
    background: radial-gradient(60% 60% at 50% 20%, rgba(255, 255, 255, 0.55) 0%, rgba(255, 255, 255, 0) 70%);
    opacity: 0.6;
    z-index: 0;
}

.header-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.header h1 {
    font-size: clamp(2.2rem, 3vw, 2.9rem);
    font-weight: 700;
    letter-spacing: -0.025em;
    color: var(--text-primary);
    text-shadow: 0 12px 40px rgba(79, 70, 229, 0.28);
}

.header p {
    font-size: 1.1rem;
    color: var(--muted);
    max-width: 680px;
}

.header-nav {
    margin-top: 18px;
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.32);
    box-shadow: 0 24px 48px rgba(236, 72, 153, 0.15);
    backdrop-filter: blur(16px);
}

.header-nav a {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 22px;
    border-radius: 999px;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.24s ease;
}

.header-nav a::before {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: inherit;
    background: radial-gradient(circle at top, rgba(236, 72, 153, 0.17), transparent 70%);
    opacity: 0;
    transition: opacity 0.24s ease;
}

.header-nav a:hover {
    color: var(--accent-strong);
    transform: translateY(-1px);
}

.header-nav a:hover::before {
    opacity: 1;
}

.header-nav a.active {
    background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 16px 32px rgba(236, 72, 153, 0.32);
}

.header-nav a.active::before {
    display: none;
}

.chart-panel {
    position: relative;
    background: rgba(255, 255, 255, 0.94);
    border-radius: 24px;
    padding: 32px;
    border: 1px solid rgba(226, 232, 240, 0.65);
    box-shadow: 0 24px 42px rgba(15, 23, 42, 0.12);
    margin: 0 56px 32px;
}

.chart-panel h2 {
    font-size: 1.45rem;
    margin-bottom: 24px;
    color: var(--text-secondary);
    letter-spacing: -0.01em;
    display: flex;
    align-items: center;
    gap: 12px;
}

.chart-panel h2::after {
    content: '';
    flex: 1;
    height: 1px;
    margin-left: 8px;
    background: linear-gradient(90deg, rgba(236, 72, 153, 0.25), transparent 70%);
}

.chart-container {
    position: relative;
    height: 420px;
    width: 100%;
}

.panels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
    gap: 26px;
    padding: 0 56px 56px;
}

.panel {
    position: relative;
    background: rgba(255, 255, 255, 0.94);
    border-radius: 24px;
    padding: 28px 28px 24px;
    border: 1px solid rgba(226, 232, 240, 0.65);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.panel.full-width {
    grid-column: 1 / -1;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.panel h2 {
    font-size: 1.35rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 12px;
    letter-spacing: -0.01em;
}

.panel h2[title] {
    cursor: help;
}

.timeline {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.timeline-card {
    padding: 18px 20px;
    border-radius: 18px;
    background: rgba(248, 250, 252, 0.9);
    border: 1px solid rgba(226, 232, 240, 0.6);
    box-shadow: 0 15px 28px rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.timeline-card strong {
    color: var(--text-secondary);
    letter-spacing: 0.02em;
}

.video-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.video-item {
    padding: 18px 16px;
    border-radius: 20px;
    background: rgba(248, 250, 252, 0.85);
    border: 1px solid rgba(226, 232, 240, 0.6);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 18px;
    transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
}

.video-item:hover {
    transform: translateY(-2px);
    border-color: rgba(236, 72, 153, 0.45);
    box-shadow: 0 18px 32px rgba(15, 23, 42, 0.12);
}

.video-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.video-title {
    color: var(--text-secondary);
    font-size: 0.98rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.video-rank {
    font-weight: 700;
    color: var(--accent-strong);
}

.video-stats {
    font-size: 0.86rem;
    color: var(--muted);
}

.rank-change {
    font-weight: 700;
    font-size: 1.2rem;
    min-width: 110px;
    text-align: right;
    letter-spacing: 0.02em;
}

.rank-change.up {
    color: var(--success);
}

.rank-change.down {
    color: var(--danger);
}

.rank-change.neutral {
    color: var(--neutral);
}

.empty-state {
    padding: 48px 20px;
    text-align: center;
    color: var(--muted);
}

.loading {
    text-align: center;
    padding: 72px 20px;
    color: var(--muted);
}

.loading-spinner {
    border: 4px solid rgba(226, 232, 240, 0.85);
    border-top: 4px solid #ec4899;
    border-radius: 50%;
    width: 52px;
    height: 52px;
    animation: spin 1s linear infinite;
    margin: 0 auto 24px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 1280px) {
    body {
        padding: 36px 18px;
    }

    .container {
        border-radius: 26px;
    }

    .header {
        padding: 48px 44px 36px;
    }

    .chart-panel {
        margin: 0 44px 28px;
        padding: 28px;
    }

    .panels {
        padding: 0 44px 44px;
    }
}

@media (max-width: 960px) {
    .panels {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    body {
        padding: 28px 12px;
    }

    .header {
        padding: 42px 28px 32px;
    }

    .header-nav {
        width: 100%;
        justify-content: space-between;
    }

    .header-nav a {
        flex: 1;
        justify-content: center;
        font-size: 0.92rem;
    }

    .chart-panel {
        margin: 0 28px 26px;
    }

    .panels {
        padding: 0 28px 32px;
    }
}

@media (max-width: 560px) {
    .header-nav {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
    }

    .video-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .rank-change {
        text-align: left;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üìà Ranking History</h1>
                <p>Track how Tiny Desk concerts have moved in the rankings over time</p>
                <nav class="header-nav">
                    <a href="/">üìã Full List</a>
                    <a href="/dashboard">üìä Dashboard</a>
                    <a href="/history" class="active">üìà History</a>
                </nav>
            </div>
        </div>
        
        <div class="chart-panel">
            <h2>üìà Top 5 Ranking Evolution Over Time</h2>
            <div class="chart-container">
                <canvas id="rankingChart"></canvas>
            </div>
        </div>
        
        <div class="panels" id="panels">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div>Loading ranking history...</div>
            </div>
        </div>
    </div>
    
    <script>
        let rankingChart = null;
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 0) return 'Never';
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }
        
        function getRankChangeDisplay(change) {
            if (change > 0) {
                return `<span class="rank-change up">‚Üë ${change}</span>`;
            } else if (change < 0) {
                return `<span class="rank-change down">‚Üì ${Math.abs(change)}</span>`;
            } else {
                return `<span class="rank-change neutral">‚àí</span>`;
            }
        }
        
        function renderRankingChart(data) {
            if (!data.evolution || Object.keys(data.evolution).length === 0) {
                return;
            }
            
            // Get top 5 current videos for the chart
            const sortedVideos = Object.values(data.evolution)
                .sort((a, b) => a.currentRank - b.currentRank)
                .slice(0, 5);
            
            const timestamps = data.timestamps || [];
            
            // Color palette for different videos
            const colors = [
                'rgba(102, 126, 234, 1)',   // Purple
                'rgba(255, 107, 107, 1)',   // Red  
                'rgba(46, 213, 115, 1)',    // Green
                'rgba(255, 195, 0, 1)',     // Yellow
                'rgba(118, 75, 162, 1)'     // Dark purple
            ];
            
            const datasets = sortedVideos.map((video, index) => {
                return {
                    label: video.title.length > 40 ? video.title.substring(0, 40) + '...' : video.title,
                    data: video.history.map(h => h.rank),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
                    tension: 0.3,
                    fill: false
                };
            });
            
            const ctx = document.getElementById('rankingChart');
            if (rankingChart) {
                rankingChart.destroy();
            }
            
            rankingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps.map(ts => {
                        const date = new Date(ts * 1000);
                        return date.toLocaleTimeString();
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Lower rank number = Better position (Rank #1 is best)'
                        },
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Rank #' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            reverse: true,
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '#' + value;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Ranking Position (lower = better)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
        }
        
        async function loadHistory() {
            try {
                const response = await fetch('/api/ranking-history');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                renderRankingChart(data);
                renderHistory(data);
                
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('panels').innerHTML = 
                    `<div class="loading"><div style="color: #dc3545;">Error: ${error.message}</div></div>`;
            }
        }
        
        function renderHistory(data) {
            const timestamps = data.timestamps || [];
            const topMovers = data.topMovers || [];
            const biggestFallers = data.biggestFallers || [];
            
            let html = '';
            
            if (timestamps.length > 0) {
                const firstUpdate = formatDate(timestamps[0]);
                const lastUpdate = formatDate(timestamps[timestamps.length - 1]);
                const totalUpdates = timestamps.length;
                
                html += `
                    <div class="panel full-width">
                        <div class="panel-header">
                            <h2>‚è±Ô∏è Timeline</h2>
                        </div>
                        <div class="timeline">
                            <div class="timeline-card">
                                <strong>First Update</strong>
                                <span>${firstUpdate}</span>
                            </div>
                            <div class="timeline-card">
                                <strong>Total Updates</strong>
                                <span>${totalUpdates}</span>
                            </div>
                            <div class="timeline-card">
                                <strong>Latest Update</strong>
                                <span>${lastUpdate}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="panel">
                    <div class="panel-header">
                        <h2>üöÄ Biggest Climbers</h2>
                    </div>
                    <div class="video-list">
            `;
            
            if (topMovers.length === 0 || topMovers.every(v => v.rankChange === 0)) {
                html += `
                        <div class="empty-state">
                            <div style="font-size: 3em; margin-bottom: 16px;">‚è≥</div>
                            <div style="font-size: 1.05em;">Waiting for next update...</div>
                            <div style="margin-top: 10px; font-size: 0.9em;">Rank changes will appear after the next data fetch</div>
                        </div>
                `;
            } else {
                topMovers.slice(0, 10).forEach(video => {
                    if (video.rankChange > 0) {
                        html += `
                        <div class="video-item">
                            <div class="video-info">
                                <div class="video-title">
                                    <span class="video-rank">#${video.currentRank}</span>
                                    ${video.title}
                                </div>
                                <div class="video-stats">Was #${video.previousRank}</div>
                            </div>
                            ${getRankChangeDisplay(video.rankChange)}
                        </div>
                        `;
                    }
                });
            }
            
            html += `
                    </div>
                </div>
            `;
            
            html += `
                <div class="panel">
                    <div class="panel-header">
                        <h2>üìâ Biggest Fallers</h2>
                    </div>
                    <div class="video-list">
            `;
            
            if (biggestFallers.length === 0 || biggestFallers.every(v => v.rankChange === 0)) {
                html += `
                        <div class="empty-state">
                            <div style="font-size: 3em; margin-bottom: 16px;">‚è≥</div>
                            <div style="font-size: 1.05em;">Waiting for next update...</div>
                            <div style="margin-top: 10px; font-size: 0.9em;">Rank changes will appear after the next data fetch</div>
                        </div>
                `;
            } else {
                biggestFallers.slice(0, 10).forEach(video => {
                    if (video.rankChange < 0) {
                        html += `
                        <div class="video-item">
                            <div class="video-info">
                                <div class="video-title">
                                    <span class="video-rank">#${video.currentRank}</span>
                                    ${video.title}
                                </div>
                                <div class="video-stats">Was #${video.previousRank}</div>
                            </div>
                            ${getRankChangeDisplay(video.rankChange)}
                        </div>
                        `;
                    }
                });
            }
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('panels').innerHTML = html;
        }
        
        // Load on page load
        loadHistory();
        
        // Auto-refresh every 2 minutes
        setInterval(loadHistory, 2 * 60 * 1000);
    </script>
</body>
</html>

